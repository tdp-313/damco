(function(){"use strict";class c{constructor(t){this.io=new Set,this.original=typeof t=="boolean"?t:!1,this.device=""}}const b="QDDSSRC",h="QDSPSRC",F="QRPGSRC",w="QCLSRC",x="QRPGLESRC",g=async d=>{let n=await d.getFile(),a="★";if(n.name.length>3){let u=n.name.substring(n.name.indexOf(".")+1,n.name.length);isNaN(Number(u))||(a=Number(u),a<10&&(a=a))}let r={timestamp:await n.lastModifiedDate.toLocaleString(),text:"",textArray:[],encode:"utf-8",ext:a,handle:d};const e=await(await fetch(URL.createObjectURL(n))).arrayBuffer(),l=new TextDecoder("utf-8").decode(e);let s=l;if(l.includes("�")){const p=new TextDecoder("Shift-JIS").decode(e);p.includes("�")||(s=p,r.encode="Shift-JIS")}if(s==="")return r;r.text=s;let m=s.split(/\r\n|\r|\n/);return r.textArray=m,r};self.onmessage=async d=>{let t=d.data;if(t.refListFile.dds.clear(),t.refListFile.dsp.clear(),t.refListFile.pgm.clear(),t.lang==="rpg-indent")t.refListFile=await L(t.textLine,t.refListFile);else if(t.lang==="dds")if(t.langType==="dsp")t.refListFile.dsp.set(t.uri_parse.member,{name:t.uri_parse.member,use:new c(!1),isFound:!1,data:{},uri_path:{}});else if(t.langType==="dds")t.refListFile.dds.set(t.uri_parse.member,{name:t.uri_parse.member,use:new c(!1),isFound:!1,data:{},uri_path:{}});else return self.postMessage(t),null;else return self.postMessage(t),null;let n=[];for(let e=0;e<t.refDefRootHandle.length;e++)for await(const i of t.refDefRootHandle[e].handle.values())for(let l=0;l<t.searchLibName.length;l++)i.name.indexOf(t.searchLibName[l])!==-1&&n.push({handle:i,root:t.refDefRootHandle[e].name,lib:i.name});let a=[],o=[];for(let e=0;e<n.length;e++)for await(const i of n[e].handle.values())t.refListFile.dds.size>0&&i.name.indexOf(b)!==-1&&(a.push({handle:i,root:n[e].root,lib:n[e].lib,file:i.name,type:"dds"}),o.push({handle:i,root:n[e].root,lib:n[e].lib,file:i.name,type:"dds"})),t.refListFile.dsp.size>0&&i.name.indexOf(h)!==-1&&a.push({handle:i,root:n[e].root,lib:n[e].lib,file:i.name,type:"dsp"}),t.refListFile.pgm.size>0&&(i.name.indexOf(w)!==-1||i.name.indexOf(F)!==-1||i.name.indexOf(x)!==-1)&&a.push({handle:i,root:n[e].root,lib:n[e].lib,file:i.name,type:"pgm"});let r=[];for(let e=0;e<a.length;e++)for await(const i of a[e].handle.values()){const l=i.name.replace(/\.[^/.]+$/,"");if(t.refListFile[a[e].type].has(l)){let s=t.refListFile[a[e].type].get(l);if(!s.isFound){let m=await g(i);s.data=m,s.uri_path={root:a[e].root,lib:a[e].lib,file:a[e].file,member:l},s.isFound=!0,t.refListFile[a[e].type].set(l,s),r.push({handle:i,root:a[e].root,lib:a[e].lib,file:a[e].file,type:a[e].type,member:l,use:s.use})}}}let f=new Map;for(let e=0;e<r.length;e++)if(r[e].type==="dds"){let i=await t.refListFile[r[e].type].get(r[e].member).data;for(let l=0;l<i.textArray.length;l++){let s=i.textArray[l];if(s.substring(5,6)==="A"&&s.substring(6,7)!=="*"&&s.substring(44,49).trim()==="PFILE"){let u=s.substring(50,s.indexOf(")")),p=structuredClone(r[e]);if(f.has(u)){let _=await f.get(u);p.use.io=new Set([..._.use.io,...p.use.io])}p.use.original=!1,f.set(u,p)}}}f.forEach((e,i)=>{let l=e.use;if(t.refListFile.dds.has(i)){let s=t.refListFile.dds.get(i);l.io=new Set([...s.use.io,...l.io])}t.refListFile.dds.set(i,{name:i,use:l,isFound:!1,data:{}})});for(let e=0;e<o.length;e++)for await(const i of o[e].handle.values()){const l=i.name.replace(/\.[^/.]+$/,"");if(t.refListFile[o[e].type].has(l)){let s=t.refListFile[o[e].type].get(l);if(!s.isFound){let m=await g(i);s.data=m,s.uri_path={root:o[e].root,lib:o[e].lib,file:o[e].file,member:l},s.isFound=!0,t.refListFile[o[e].type].set(l,s),r.push({handle:i,root:o[e].root,lib:o[e].lib,file:o[e].file,type:o[e].type,member:l,use:s.use})}}}t.isComplete=!0,self.postMessage(t)};const L=async d=>{let t=new Map,n=new Map,a=new Map;for(let o=0;o<d.length;o++){let r=d[o];if(r.substring(5,6)==="F"&&r.substring(6,7)!=="*"){let f=r.substring(39,46).trim(),e=r.substring(6,14).trim(),i=r.substring(14,15).trim(),l=r.substring(65,66).trim(),s=new c(!0);s.device=f,l==="A"&&s.io.add("O"),i==="I"?s.io.add("I"):i==="U"?s.io.add("U"):i==="O"&&s.io.add("O"),f==="WORKSTN"?(n.has(e)&&(s.io=new Set([...s.io,...n.get(e).use.io])),n.set(e,{name:e,use:s,isFound:!1,data:{},uri_path:{}})):f==="DISK"?(t.has(e)&&(s.io=new Set([...s.io,...t.get(e).use.io])),t.set(e,{name:e,use:s,isFound:!1,data:{},uri_path:{}})):f==="PRINTER"&&(t.has(e)&&(s.io=new Set([...s.io,...t.get(e).use.io])),t.set(e,{name:e,use:s,isFound:!1,data:{},uri_path:{}}))}else if(r.substring(5,6)==="C"&&r.substring(6,7)!=="*"){let f=r.substring(45,50).trim(),i=r.substring(50,60).trim().replace(/'/g,"");if(f==="CALL"){let l=new c(!0);l.device="PGM",l.io=new Set(["-","-"]),a.set(i,{name:i,use:l,isFound:!1,data:{},uri_path:{}})}}}return{dds:t,dsp:n,pgm:a}}})();
