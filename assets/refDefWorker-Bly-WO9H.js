(function(){"use strict";class b{constructor(e){this.io=new Set,this.original=typeof e=="boolean"?e:!1,this.device=""}}const _="QDDSSRC",w="QDSPSRC",y="QRPGSRC",L="QCLSRC",R="QRPGLESRC",F=async d=>{let n=await d.getFile(),u="★";if(n.name.length>3){let l=n.name.substring(n.name.indexOf(".")+1,n.name.length);isNaN(Number(l))||(u=Number(l),u<10&&(u=u))}let s={timestamp:await n.lastModifiedDate.toLocaleString(),text:"",textArray:[],encode:"utf-8",ext:u,handle:d};const o=await(await fetch(URL.createObjectURL(n))).arrayBuffer(),t=new TextDecoder("utf-8").decode(o);let i=t;if(t.includes("�")){const c=new TextDecoder("Shift-JIS").decode(o);c.includes("�")||(i=c,s.encode="Shift-JIS")}if(i==="")return s;s.text=i;let r=i.split(/\r\n|\r|\n/);return s.textArray=r,s};function S(d,e){if(e.startsWith("%")&&e.endsWith("%")&&e.length>2){const n=e.slice(1,-1);return d.includes(n)}else if(e.startsWith("%")){const n=e.slice(1);return d.endsWith(n)}else if(e.endsWith("%")){const n=e.slice(0,-1);return d.startsWith(n)}else return d===e}self.onmessage=async d=>{let e=d.data,n=e.regExp.div,u=e.regExp.search;if(e.refListFile.dds.clear(),e.refListFile.dsp.clear(),e.refListFile.pgm.clear(),e.lang==="rpg-indent")e.refListFile=await M(e.textLine,e.refListFile);else if(e.lang==="dds")if(e.langType==="dsp")e.refListFile.dsp.set(e.uri_parse.member,{name:e.uri_parse.member,use:new b(!1),isFound:!1,data:{},uri_path:{},isRegExpFound:!1});else if(e.langType==="dds")e.refListFile.dds.set(e.uri_parse.member,{name:e.uri_parse.member,use:new b(!1),isFound:!1,data:{},uri_path:{},isRegExpFound:!1});else return self.postMessage(e),null;else return self.postMessage(e),null;let a=[];for(let t=0;t<e.refDefRootHandle.length;t++){if(e.refDefRootHandle[t].handle===null)return console.warn("handle is Null"),null;for await(const i of e.refDefRootHandle[t].handle.values())for(let r=0;r<e.searchLibName.length;r++)S(i.name,e.searchLibName[r])&&a.push({handle:i,root:e.refDefRootHandle[t].name,lib:i.name})}let s=[],f=[];for(let t=0;t<a.length;t++)for await(const i of a[t].handle.values())e.refListFile.dds.size>0&&i.name.indexOf(_)!==-1&&(s.push({handle:i,root:a[t].root,lib:a[t].lib,file:i.name,type:"dds"}),f.push({handle:i,root:a[t].root,lib:a[t].lib,file:i.name,type:"dds"})),e.refListFile.dsp.size>0&&i.name.indexOf(w)!==-1&&s.push({handle:i,root:a[t].root,lib:a[t].lib,file:i.name,type:"dsp"}),e.refListFile.pgm.size>0&&(i.name.indexOf(L)!==-1||i.name.indexOf(y)!==-1||i.name.indexOf(R)!==-1)&&s.push({handle:i,root:a[t].root,lib:a[t].lib,file:i.name,type:"pgm"});let o=new Map;for(let t=0;t<s.length;t++)for await(const i of s[t].handle.values()){const r=i.name.replace(/\.[^/.]+$/,"");if(e.refListFile[s[t].type].has(r)){let l=e.refListFile[s[t].type].get(r);if(!l.isFound){let c=await F(i);l.data=c,l.uri_path={root:s[t].root,lib:s[t].lib,file:s[t].file,member:r},l.isFound=!0,e.refListFile[s[t].type].set(r,l),o.set(l.uri_path.root+l.uri_path.lib+l.uri_path.member,{handle:i,root:s[t].root,lib:s[t].lib,file:s[t].file,type:s[t].type,member:r,searchKey:r,use:l.use})}}else n!==""&&u!==""&&e.refListFile[s[t].type].forEach(async(l,c)=>{if(!l.isFound&&!l.isRegExpFound){let h=E(c,n),g=u;if(typeof h=="object")for(let m=0;m<h.length;m++)g=g.replace("${strA["+m+"]}",h[m]);if(new RegExp(g).test(r)){let m=await F(i);l.data=m,l.uri_path={root:s[t].root,lib:s[t].lib,file:s[t].file,member:r},l.isRegExpFound=!0,e.refListFile[s[t].type].set(c,l),o.set(l.uri_path.root+l.uri_path.lib+l.uri_path.member,{handle:i,root:s[t].root,lib:s[t].lib,file:s[t].file,type:s[t].type,member:r,searchKey:c,use:l.use})}}})}let p=new Map;o.forEach(t=>{if(t.type==="dds"){let i=e.refListFile[t.type].get(t.searchKey).data;for(let r=0;r<i.textArray.length;r++){let l=i.textArray[r];if(l.substring(5,6)==="A"&&l.substring(6,7)!=="*"&&l.substring(44,49).trim()==="PFILE"){let h=l.substring(50,l.indexOf(")")),g=structuredClone(t);if(p.has(h)){let x=p.get(h);g.use.io=new Set([...x.use.io,...g.use.io])}g.use.original=!1,p.set(h,g)}}}}),p.forEach((t,i)=>{let r=t.use;if(e.refListFile.dds.has(i)){let l=e.refListFile.dds.get(i);r.io=new Set([...l.use.io,...r.io])}e.refListFile.dds.set(i,{name:i,use:r,isFound:!1,data:{}})});for(let t=0;t<f.length;t++)for await(const i of f[t].handle.values()){const r=i.name.replace(/\.[^/.]+$/,"");if(e.refListFile[f[t].type].has(r)){let l=e.refListFile[f[t].type].get(r);if(!l.isFound){let c=await F(i);l.data=c,l.uri_path={root:f[t].root,lib:f[t].lib,file:f[t].file,member:r},l.isFound=!0,e.refListFile[f[t].type].set(r,l)}}}e.isComplete=!0,self.postMessage(e)};function E(d,e){let n=[];const u=new RegExp(e),a=d.match(u);if(a)for(let s=0;s<a.length;s++)a[s]!==""?n.push(a[s]):n.push("");else n=[];return n}const M=async d=>{let e=new Map,n=new Map,u=new Map;for(let a=0;a<d.length;a++){let s=d[a];if(s.substring(5,6)==="F"&&s.substring(6,7)!=="*"){let f=s.substring(39,46).trim(),o=s.substring(6,14).trim(),p=s.substring(14,15).trim(),t=s.substring(65,66).trim(),i=new b(!0);i.device=f,t==="A"&&i.io.add("O"),p==="I"?i.io.add("I"):p==="U"?i.io.add("U"):p==="O"&&i.io.add("O"),f==="WORKSTN"?(n.has(o)&&(i.io=new Set([...i.io,...n.get(o).use.io])),n.set(o,{name:o,use:i,isFound:!1,data:{},uri_path:{},isRegExpFound:!1})):f==="DISK"?(e.has(o)&&(i.io=new Set([...i.io,...e.get(o).use.io])),e.set(o,{name:o,use:i,isFound:!1,data:{},uri_path:{},isRegExpFound:!1})):f==="PRINTER"&&(e.has(o)&&(i.io=new Set([...i.io,...e.get(o).use.io])),e.set(o,{name:o,use:i,isFound:!1,data:{},uri_path:{},isRegExpFound:!1}))}else if(s.substring(5,6)==="C"&&s.substring(6,7)!=="*"){let f=s.substring(45,50).trim(),p=s.substring(50,60).trim().replace(/'/g,"");if(f==="CALL"){let t=new b(!0);t.device="PGM",t.io=new Set(["-","-"]),u.set(p,{name:p,use:t,isFound:!1,data:{},uri_path:{},isRegExpFound:!1})}}}return{dds:e,dsp:n,pgm:u}}})();
