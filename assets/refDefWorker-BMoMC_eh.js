(function(){"use strict";class b{constructor(t){this.io=new Set,this.original=typeof t=="boolean"?t:!1,this.device=""}}const _="QDDSSRC",w="QDSPSRC",y="QRPGSRC",L="QCLSRC",R="QRPGLESRC",F=async m=>{let o=await m.getFile(),d="★";if(o.name.length>3){let l=o.name.substring(o.name.indexOf(".")+1,o.name.length);isNaN(Number(l))||(d=Number(l),d<10&&(d=d))}let s={timestamp:await o.lastModifiedDate.toLocaleString(),text:"",textArray:[],encode:"utf-8",ext:d,handle:m};const n=await(await fetch(URL.createObjectURL(o))).arrayBuffer(),e=new TextDecoder("utf-8").decode(n);let i=e;if(e.includes("�")){const p=new TextDecoder("Shift-JIS").decode(n);p.includes("�")||(i=p,s.encode="Shift-JIS")}if(i==="")return s;s.text=i;let r=i.split(/\r\n|\r|\n/);return s.textArray=r,s};self.onmessage=async m=>{let t=m.data,o=t.regExp.div,d=t.regExp.search;if(t.refListFile.dds.clear(),t.refListFile.dsp.clear(),t.refListFile.pgm.clear(),t.lang==="rpg-indent")t.refListFile=await E(t.textLine,t.refListFile);else if(t.lang==="dds")if(t.langType==="dsp")t.refListFile.dsp.set(t.uri_parse.member,{name:t.uri_parse.member,use:new b(!1),isFound:!1,data:{},uri_path:{},isRegExpFound:!1});else if(t.langType==="dds")t.refListFile.dds.set(t.uri_parse.member,{name:t.uri_parse.member,use:new b(!1),isFound:!1,data:{},uri_path:{},isRegExpFound:!1});else return self.postMessage(t),null;else return self.postMessage(t),null;let a=[];for(let e=0;e<t.refDefRootHandle.length;e++){if(t.refDefRootHandle[e].handle===null)return console.warn("handle is Null"),null;for await(const i of t.refDefRootHandle[e].handle.values())for(let r=0;r<t.searchLibName.length;r++)i.name.indexOf(t.searchLibName[r])!==-1&&a.push({handle:i,root:t.refDefRootHandle[e].name,lib:i.name})}let s=[],f=[];for(let e=0;e<a.length;e++)for await(const i of a[e].handle.values())t.refListFile.dds.size>0&&i.name.indexOf(_)!==-1&&(s.push({handle:i,root:a[e].root,lib:a[e].lib,file:i.name,type:"dds"}),f.push({handle:i,root:a[e].root,lib:a[e].lib,file:i.name,type:"dds"})),t.refListFile.dsp.size>0&&i.name.indexOf(w)!==-1&&s.push({handle:i,root:a[e].root,lib:a[e].lib,file:i.name,type:"dsp"}),t.refListFile.pgm.size>0&&(i.name.indexOf(L)!==-1||i.name.indexOf(y)!==-1||i.name.indexOf(R)!==-1)&&s.push({handle:i,root:a[e].root,lib:a[e].lib,file:i.name,type:"pgm"});let n=new Map;for(let e=0;e<s.length;e++)for await(const i of s[e].handle.values()){const r=i.name.replace(/\.[^/.]+$/,"");if(t.refListFile[s[e].type].has(r)){let l=t.refListFile[s[e].type].get(r);if(!l.isFound){let p=await F(i);l.data=p,l.uri_path={root:s[e].root,lib:s[e].lib,file:s[e].file,member:r},l.isFound=!0,t.refListFile[s[e].type].set(r,l),n.set(l.uri_path.root+l.uri_path.lib+l.uri_path.member,{handle:i,root:s[e].root,lib:s[e].lib,file:s[e].file,type:s[e].type,member:r,searchKey:r,use:l.use})}}else o!==""&&d!==""&&t.refListFile[s[e].type].forEach(async(l,p)=>{if(!l.isFound&&!l.isRegExpFound){let c=S(p,o),g=d;if(typeof c=="object")for(let h=0;h<c.length;h++)g=g.replace("${strA["+h+"]}",c[h]);if(new RegExp(g).test(r)){let h=await F(i);l.data=h,l.uri_path={root:s[e].root,lib:s[e].lib,file:s[e].file,member:r},l.isRegExpFound=!0,t.refListFile[s[e].type].set(p,l),n.set(l.uri_path.root+l.uri_path.lib+l.uri_path.member,{handle:i,root:s[e].root,lib:s[e].lib,file:s[e].file,type:s[e].type,member:r,searchKey:p,use:l.use})}}})}let u=new Map;n.forEach(e=>{if(e.type==="dds"){let i=t.refListFile[e.type].get(e.searchKey).data;for(let r=0;r<i.textArray.length;r++){let l=i.textArray[r];if(l.substring(5,6)==="A"&&l.substring(6,7)!=="*"&&l.substring(44,49).trim()==="PFILE"){let c=l.substring(50,l.indexOf(")")),g=structuredClone(e);if(u.has(c)){let x=u.get(c);g.use.io=new Set([...x.use.io,...g.use.io])}g.use.original=!1,u.set(c,g)}}}}),u.forEach((e,i)=>{let r=e.use;if(t.refListFile.dds.has(i)){let l=t.refListFile.dds.get(i);r.io=new Set([...l.use.io,...r.io])}t.refListFile.dds.set(i,{name:i,use:r,isFound:!1,data:{}})});for(let e=0;e<f.length;e++)for await(const i of f[e].handle.values()){const r=i.name.replace(/\.[^/.]+$/,"");if(t.refListFile[f[e].type].has(r)){let l=t.refListFile[f[e].type].get(r);if(!l.isFound){let p=await F(i);l.data=p,l.uri_path={root:f[e].root,lib:f[e].lib,file:f[e].file,member:r},l.isFound=!0,t.refListFile[f[e].type].set(r,l)}}}t.isComplete=!0,self.postMessage(t)};function S(m,t){let o=[];const d=new RegExp(t),a=m.match(d);if(a)for(let s=0;s<a.length;s++)a[s]!==""?o.push(a[s]):o.push("");else o=[];return o}const E=async m=>{let t=new Map,o=new Map,d=new Map;for(let a=0;a<m.length;a++){let s=m[a];if(s.substring(5,6)==="F"&&s.substring(6,7)!=="*"){let f=s.substring(39,46).trim(),n=s.substring(6,14).trim(),u=s.substring(14,15).trim(),e=s.substring(65,66).trim(),i=new b(!0);i.device=f,e==="A"&&i.io.add("O"),u==="I"?i.io.add("I"):u==="U"?i.io.add("U"):u==="O"&&i.io.add("O"),f==="WORKSTN"?(o.has(n)&&(i.io=new Set([...i.io,...o.get(n).use.io])),o.set(n,{name:n,use:i,isFound:!1,data:{},uri_path:{},isRegExpFound:!1})):f==="DISK"?(t.has(n)&&(i.io=new Set([...i.io,...t.get(n).use.io])),t.set(n,{name:n,use:i,isFound:!1,data:{},uri_path:{},isRegExpFound:!1})):f==="PRINTER"&&(t.has(n)&&(i.io=new Set([...i.io,...t.get(n).use.io])),t.set(n,{name:n,use:i,isFound:!1,data:{},uri_path:{},isRegExpFound:!1}))}else if(s.substring(5,6)==="C"&&s.substring(6,7)!=="*"){let f=s.substring(45,50).trim(),u=s.substring(50,60).trim().replace(/'/g,"");if(f==="CALL"){let e=new b(!0);e.device="PGM",e.io=new Set(["-","-"]),d.set(u,{name:u,use:e,isFound:!1,data:{},uri_path:{},isRegExpFound:!1})}}}return{dds:t,dsp:o,pgm:d}}})();
